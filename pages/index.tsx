import Head from "next/head";
import React, { useEffect, useRef, useState } from "react";
import TestResult from "../components/TestResult";

function runTest(data: any, name: any) {
  const result = data.input.map((v: any) => {
    const actual =
      v.gpa >= 0 && v.gpa <= 4 && v.credit >= 0 && v.credit <= 134 ? "P" : "F";
    const result = actual === v.expected ? "TestPass" : "TestFail";

    return { ...v, actual, result };
  });

  return result;
}

export default function Home() {
  const nameInput = useRef<HTMLInputElement>(null);
  const selectTest = useRef<HTMLSelectElement>(null);

  const [testCases, setTestCases] = useState<any>([]);
  const [name, setName] = useState<any>("");

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    console.log(nameInput.current?.value);
    console.log(selectTest.current?.value);

    const res = await fetch(`/api/test/${selectTest.current?.value}`);
    const data = await res.json();

    setTestCases(runTest(data, nameInput.current?.value));
    setName(nameInput.current?.value);
  };

  useEffect(() => {
    fetch(`/api/test/bva`)
      .then((res) => res.json())
      .then((data) => console.log(data));
  }, []);

  return (
    <>
      <Head>
        <title>Test GPA</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="flex flex-col w-full items-center">
        <h1 className="text-3xl font-bold m-10 non-printable">
          Test GPA and Credit
        </h1>
        <form onSubmit={handleSubmit} className="non-printable">
          <label>Run by</label>
          <input
            placeholder="name"
            className="p-3 border w-full rounded-lg mt-2 mb-3"
            id="inputName"
            ref={nameInput}
            required
          />
          <label>Select Test</label>
          <select
            id="cars"
            name="test"
            className="p-3 border border-neutral-300 rounded-full ml-3 mb-3 cursor-pointer"
            ref={selectTest}
          >
            <option value="bva">BVA</option>
            <option value="robustness">Robustness</option>
            <option value="wc_bva">Worst case BVA</option>
            <option value="wc_robustness">Worst case Robustness</option>
          </select>

          <button
            type="submit"
            className="mt-3 p-3 rounded-md bg-purple-100 hover:bg-purple-200 duration-300 text-purple-700 text-semibold block mx-auto"
          >
            Run Test
          </button>
        </form>

        {testCases.length !== 0 && (
          <>
            <TestResult testCases={testCases} name={name} />
            <button
              className="mb-10 p-3 rounded-md bg-purple-100 hover:bg-purple-200 duration-300 text-purple-700 text-semibold non-printable"
              onClick={() => print()}
            >
              Print
            </button>
          </>
        )}
      </main>
    </>
  );
}
